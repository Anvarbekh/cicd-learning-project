name: Python CI/CD Pipeline

on:
  push:
    branches:
      - 'main'
      - 'my-feature-branch'
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install ruff
      - name: Lint with Ruff
        run: ruff check .

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - name: Run tests with Pytest
        run: PYTHONPATH=. pytest

  build-and-push:
    runs-on: ubuntu-latest
    needs: [lint, test]
    # IMPORTANT: This job only runs on pushes to the 'main' branch.
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push the Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}

  deploy_staging:
    runs-on: ubuntu-latest
    needs: build-and-push
    # This 'if' is technically redundant because it depends on build-and-push,
    # but it adds clarity.
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: http://staging.example.com
    steps:
      - name: 'Simulate Deploying to Staging'
        env:
          IMAGE_NAME: ghcr.io/${{ github.repository }}:${{ github.sha }}
          SERVER_IP: ${{ secrets.STAGING_SERVER_IP }}
        run: |
          echo "ðŸš€ Starting deployment to STAGING environment..."
          echo "ðŸšš Connecting to server at IP: $SERVER_IP"
          echo "ðŸ“¦ Pulling image: $IMAGE_NAME"
          echo "âœ… Deployment to staging complete!"

  deploy_production:
    runs-on: ubuntu-latest
    needs: build-and-push
    # IMPORTANT: This job only runs when manually triggered.
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://production.example.com
    steps:
      - name: 'Simulate Deploying to Production'
        env:
          IMAGE_NAME: ghcr.io/${{ github.repository }}:latest
          SERVER_IP: ${{ secrets.PROD_SERVER_IP }}
        run: |
          echo "ðŸš€ Starting deployment to PRODUCTION environment..."
          echo "ðŸšš Connecting to server at IP: $SERVER_IP"
          echo "ðŸ“¦ Pulling image: $IMAGE_NAME"
          echo "âœ… Deployment to production complete!"