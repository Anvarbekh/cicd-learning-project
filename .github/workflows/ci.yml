name: Python CI/CD Pipeline

on: [push]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install ruff
      - name: Lint with Ruff
        run: ruff check .

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - name: Run tests with Pytest
        run: PYTHONPATH=. pytest

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build and load the Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          push: false
          tags: my-learning-app:latest

  # NEW JOB: Deploy to Staging
  deploy_staging:
    runs-on: ubuntu-latest
    needs: build
    # This job only runs when the code is pushed to the 'main' branch
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: http://staging.example.com
    steps:
      - name: 'Simulate Deploying to Staging'
        # In a real workflow, we would use secrets for server IPs, tokens, etc.
        # ${{ secrets.STAGING_SERVER_IP }} is how you access a secret.
        env:
          SERVER_IP: ${{ secrets.STAGING_SERVER_IP }}
          API_TOKEN: ${{ secrets.STAGING_API_TOKEN }}
        run: |
          echo "ðŸš€ Starting deployment to STAGING environment..."
          echo "ðŸšš Connecting to server at IP: $SERVER_IP"
          echo "ðŸ”‘ Using API token ending in: ${API_TOKEN: -4}"
          echo "âœ… Deployment to staging complete!"

  # NEW JOB: Deploy to Production
  deploy_production:
    runs-on: ubuntu-latest
    needs: build
    # In real GitHub, this would be triggered manually or by a tag.
    # For local testing, we will trigger it by name.
    environment:
      name: production
      url: https://production.example.com
    steps:
      - name: 'Simulate Deploying to Production'
        env:
          SERVER_IP: ${{ secrets.PROD_SERVER_IP }}
          API_TOKEN: ${{ secrets.PROD_API_TOKEN }}
        run: |
          echo "ðŸš€ Starting deployment to PRODUCTION environment..."
          echo "ðŸšš Connecting to server at IP: $SERVER_IP"
          echo "ðŸ”‘ Using API token ending in: ${API_TOKEN: -4}"
          echo "âœ… Deployment to production complete!"